<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing SOP Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
            background: #f5f5f5;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .equipment-card.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .equipment-card.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .equipment-card.normal {
            border-left-color: #4caf50;
        }

        .defect-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }

        .defect-item.critical {
            border-left-color: #f44336;
        }

        .defect-item.high {
            border-left-color: #ff9800;
        }

        .defect-item.medium {
            border-left-color: #ffc107;
        }

        .status-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-badge.healthy {
            background: #4caf50;
            color: white;
        }

        .status-badge.degraded {
            background: #ff9800;
            color: white;
        }

        .status-badge.error {
            background: #f44336;
            color: white;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .agent-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .agent-card.healthy {
            border-left-color: #4caf50;
        }

        .agent-card.error {
            border-left-color: #f44336;
        }

        .agent-name {
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 8px;
        }

        .model-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .model-item {
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .model-item:last-child {
            border-bottom: none;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .upload-section {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="file"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.active {
            display: block;
        }

        .result-section {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .result-section h2 {
            color: #1a237e;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .component-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .info-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .sop-steps {
            list-style: none;
            counter-reset: step-counter;
        }

        .sop-steps li {
            counter-increment: step-counter;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-left: 50px;
        }

        .sop-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 15px;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .explanation-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .explanation-item h3 {
            color: #1a237e;
            margin-bottom: 10px;
        }

        .qa-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .qa-status.approved {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .qa-status.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .qa-status.revision {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .download-btn {
            background: #28a745;
            margin-top: 20px;
        }

        .download-btn:hover {
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.4);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Manufacturing SOP Automation</h1>
            <p>AI-Powered Standard Operating Procedure Generator</p>
        </div>

            <div class="content">
                <!-- System Status Section -->
                <div class="status-section" id="statusSection">
                    <div class="status-header">
                        <h2 style="color: #1a237e; margin: 0;">üîç System Status & Agent Health</h2>
                        <button class="refresh-btn" onclick="loadSystemStatus()">üîÑ Refresh Status</button>
                    </div>
                    <div id="statusContent">
                        <p style="text-align: center; color: #666;">Loading system status...</p>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tabs">
                    <button class="tab active" data-tab="sop">üìã SOP Generation</button>
                    <button class="tab" data-tab="aoi">üîç AOI Defect Analysis</button>
                    <button class="tab" data-tab="equipment">‚öôÔ∏è Equipment Monitoring</button>
                </div>

                <!-- SOP Tab Content -->
                <div id="sop-tab" class="tab-content active">
                    <div class="upload-section">
                        <form id="sopForm">
                            <div class="form-group">
                                <label for="imageUpload">Upload Motherboard Image</label>
                                <input type="file" id="imageUpload" name="image" accept="image/*" required>
                                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                                    ü§ñ AI will automatically detect the installation task from the image
                                </p>
                            </div>
                            <button type="submit" class="btn" id="generateBtn">Generate SOP</button>
                        </form>
                    </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing motherboard image and detecting components...</p>
                <p style="font-size: 14px; margin-top: 10px; color: #666;">
                    AI is automatically determining the installation task...
                </p>
            </div>

                    <div class="error" id="error" style="display: none;"></div>

                    <div class="results" id="results">
                <div class="result-section" style="display: none;">
                    <h2>ü§ñ Auto-Detected Task</h2>
                    <div id="detectedTask" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: #1a237e;">Task:</strong> <span id="taskName" style="font-size: 18px; color: #283593;"></span>
                    </div>
                </div>
                
                <div class="result-section">
                    <h2>üîå All Detected Connectors/Slots on Motherboard</h2>
                    <div id="allConnectors" style="margin-top: 15px;"></div>
                </div>
                
                <div class="result-section">
                    <h2>üó∫Ô∏è Annotated Motherboard Image (Component Mapping)</h2>
                    <div id="annotatedImageContainer" style="margin-top: 15px; text-align: center;">
                        <p style="color: #666;">Annotated image will appear here after analysis...</p>
                    </div>
                </div>
                
                <div class="result-section">
                    <h2>üìã All Connectors with Installation Procedures</h2>
                    <div id="allConnectorsWithSOPs"></div>
                </div>

                <div class="result-section">
                    <h2>üìã Primary Component Details</h2>
                    <div class="component-info" id="componentInfo"></div>
                </div>

                <div class="result-section">
                    <h2>üìù Primary SOP Steps</h2>
                    <ol class="sop-steps" id="sopSteps"></ol>
                </div>

                <div class="result-section">
                    <h2>üí° Detailed Explanations</h2>
                    <div id="explanations"></div>
                </div>

                <div class="result-section">
                    <h2>‚úÖ QA Validation</h2>
                    <div id="qaResult"></div>
                </div>

                    <button class="btn download-btn" id="downloadBtn">Download PDF Report</button>
                    </div>
                </div>

                <!-- AOI Tab Content -->
                <div id="aoi-tab" class="tab-content">
                    <div class="upload-section">
                        <h2 style="color: #1a237e; margin-bottom: 20px;">üîç AOI Visual Defect Analysis</h2>
                        <p style="margin-bottom: 20px; color: #666;">
                            Upload an AOI inspection image to automatically detect defects, reduce false positives, and generate QC reports.
                        </p>
                        
                        <form id="aoiForm">
                            <div class="form-group">
                                <label for="partNumber">Part Number:</label>
                                <input type="text" id="partNumber" placeholder="Enter part number">
                            </div>
                            <div class="form-group">
                                <label for="lotNumber">Lot Number:</label>
                                <input type="text" id="lotNumber" placeholder="Enter lot number">
                            </div>
                            <div class="form-group">
                                <label for="aoiImageUpload">AOI Inspection Image:</label>
                                <input type="file" id="aoiImageUpload" accept="image/*" required>
                            </div>
                            <button type="submit" class="btn" id="analyzeAoiBtn">Analyze AOI Image</button>
                        </form>

                        <div class="loading" id="aoiLoading">
                            <div class="spinner"></div>
                            <p>Analyzing AOI image for defects...</p>
                        </div>

                        <div id="aoiResults" class="results">
                            <div class="result-section">
                                <h3>üìä Detection Results</h3>
                                <div id="aoiDetectionResults"></div>
                            </div>
                            <div class="result-section">
                                <h3>üîç Detected Defects</h3>
                                <div id="aoiDefects"></div>
                            </div>
                            <div class="result-section">
                                <h3>üìã QC Report</h3>
                                <div id="aoiQCReport"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Monitoring Tab Content -->
                <div id="equipment-tab" class="tab-content">
                    <div class="upload-section">
                        <h2 style="color: #1a237e; margin-bottom: 20px;">‚öôÔ∏è Equipment Monitoring & Early Warning</h2>
                        <p style="margin-bottom: 20px; color: #666;">
                            Monitor equipment health, detect anomalies, and receive early warnings for potential failures.
                        </p>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn" id="refreshEquipmentBtn" style="width: auto; margin-right: 10px;">Refresh Equipment Status</button>
                            <button class="btn" id="loadDashboardBtn" style="width: auto;">Load Dashboard</button>
                        </div>

                        <div class="loading" id="equipmentLoading">
                            <div class="spinner"></div>
                            <p>Loading equipment data...</p>
                        </div>

                        <div id="equipmentDashboard" class="results">
                            <div class="result-section">
                                <h3>üìä Equipment Summary</h3>
                                <div id="equipmentSummary"></div>
                            </div>
                            <div class="result-section">
                                <h3>üîß Equipment Status</h3>
                                <div id="equipmentList" class="equipment-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8001';
        let currentPdfPath = '';

        // Load system status on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSystemStatus();
            // Refresh status every 30 seconds
            setInterval(loadSystemStatus, 30000);
        });

        async function loadSystemStatus() {
            const statusContent = document.getElementById('statusContent');
            if (!statusContent) return;
            
            statusContent.innerHTML = '<p style="text-align: center; color: #666;">Loading system status...</p>';

            try {
                const response = await fetch(`${BACKEND_URL}/api/status`);
                const data = await response.json();

                let html = '';

                // Overall Health
                const overallHealth = data.overall?.health || 'unknown';
                const healthPercentage = data.overall?.health_percentage || 0;
                const healthyAgents = data.overall?.healthy_agents || 0;
                const totalAgents = data.overall?.total_agents || 0;

                html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">`;
                html += `<h3 style="margin: 0; color: #1a237e;">Overall System Health</h3>`;
                html += `<span class="status-badge ${overallHealth}">${overallHealth.toUpperCase()}</span>`;
                html += `</div>`;
                html += `<div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">`;
                html += `<p style="margin: 5px 0;"><strong>Health Score:</strong> ${healthPercentage}%</p>`;
                html += `<p style="margin: 5px 0;"><strong>Healthy Agents:</strong> ${healthyAgents}/${totalAgents}</p>`;
                html += `<p style="margin: 5px 0;"><strong>Backend Status:</strong> <span style="color: #4caf50;">${data.backend?.status || 'Unknown'}</span></p>`;
                html += `<p style="margin: 5px 0;"><strong>Backend Version:</strong> ${data.backend?.version || 'N/A'}</p>`;
                html += `</div></div>`;

                // Agents Status
                html += `<h3 style="color: #1a237e; margin-top: 20px; margin-bottom: 15px;">ü§ñ Agent Status</h3>`;
                html += `<div class="agent-grid">`;

                const agents = data.agents || {};
                for (const [agentName, agentData] of Object.entries(agents)) {
                    const agentStatus = agentData.status || 'unknown';
                    const displayName = agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    html += `<div class="agent-card ${agentStatus}">`;
                    html += `<div class="agent-name">${displayName}</div>`;
                    html += `<div style="margin-bottom: 8px;"><span class="status-badge ${agentStatus}">${agentStatus.toUpperCase()}</span></div>`;
                    
                    if (agentData.capabilities) {
                        html += `<div style="font-size: 12px; color: #666; margin-top: 8px;">`;
                        html += `<strong>Capabilities:</strong><br>`;
                        agentData.capabilities.forEach(cap => {
                            html += `‚Ä¢ ${cap}<br>`;
                        });
                        html += `</div>`;
                    }

                    if (agentData.model_name) {
                        html += `<div style="font-size: 12px; color: #667eea; margin-top: 8px;"><strong>Model:</strong> ${agentData.model_name}</div>`;
                    }

                    if (agentData.device) {
                        html += `<div style="font-size: 12px; color: #666; margin-top: 4px;"><strong>Device:</strong> ${agentData.device}</div>`;
                    }

                    if (agentData.error) {
                        html += `<div style="font-size: 11px; color: #f44336; margin-top: 8px;"><strong>Error:</strong> ${agentData.error}</div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;

                // Models Information
                html += `<h3 style="color: #1a237e; margin-top: 30px; margin-bottom: 15px;">üß† AI Models</h3>`;
                html += `<div class="model-info">`;

                const models = data.models || {};
                for (const [modelKey, modelData] of Object.entries(models)) {
                    const displayName = modelKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<div class="model-item">`;
                    html += `<div style="font-weight: 600; color: #1a237e; margin-bottom: 5px;">${displayName}</div>`;
                    html += `<div style="font-size: 13px; color: #666;">`;
                    html += `<strong>Name:</strong> ${modelData.name || 'N/A'}<br>`;
                    html += `<strong>Provider:</strong> ${modelData.provider || 'N/A'}<br>`;
                    html += `<strong>Type:</strong> ${modelData.type || 'N/A'}<br>`;
                    if (modelData.architecture) {
                        html += `<strong>Architecture:</strong> ${modelData.architecture}<br>`;
                    }
                    html += `<strong>Status:</strong> <span style="color: ${modelData.status === 'configured' ? '#4caf50' : '#ff9800'}">${modelData.status || 'Unknown'}</span>`;
                    if (modelData.api_key_configured !== undefined) {
                        html += `<br><strong>API Key:</strong> <span style="color: ${modelData.api_key_configured ? '#4caf50' : '#f44336'}">${modelData.api_key_configured ? 'Configured' : 'Not Configured'}</span>`;
                    }
                    html += `</div>`;
                    html += `</div>`;
                }

                html += `</div>`;

                // System Information
                html += `<h3 style="color: #1a237e; margin-top: 30px; margin-bottom: 15px;">üíª System Information</h3>`;
                html += `<div style="background: white; padding: 15px; border-radius: 8px;">`;
                const system = data.system || {};
                html += `<p style="margin: 5px 0;"><strong>Device:</strong> ${system.device || 'N/A'}</p>`;
                html += `<p style="margin: 5px 0;"><strong>CUDA Available:</strong> <span style="color: ${system.cuda_available ? '#4caf50' : '#666'}">${system.cuda_available ? 'Yes' : 'No'}</span></p>`;
                html += `<p style="margin: 5px 0;"><strong>PyTorch Available:</strong> <span style="color: ${system.pytorch_available ? '#4caf50' : '#666'}">${system.pytorch_available ? 'Yes' : 'No'}</span></p>`;
                html += `</div>`;

                statusContent.innerHTML = html;

            } catch (error) {
                statusContent.innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; color: #c62828;">
                        <strong>Error loading system status:</strong> ${error.message}<br>
                        <small>Make sure the backend server is running on port 8001</small>
                    </div>
                `;
            }
        }

        document.getElementById('sopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (!imageFile) {
                showError('Please upload a motherboard image');
                return;
            }

            formData.append('image', imageFile);
            // Task will be automatically detected by AI

            // Show loading, hide results and error
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-sop`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || data.error || 'Failed to generate SOP');
                }

                displayResults(data);
                currentPdfPath = data.pdf_path || '';

            } catch (error) {
                showError(error.message || 'An error occurred while generating SOP');
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateBtn').disabled = false;
            }
        });

        function displayResults(data) {
            // Display detected task
            const taskName = document.getElementById('taskName');
            if (taskName) {
                taskName.textContent = data.task || 'Unknown Task';
            }
            
            // Display all connectors list
            const allConnectors = data.all_connectors || [];
            const connectorsDiv = document.getElementById('allConnectors');
            if (connectorsDiv && allConnectors.length > 0) {
                let connectorsHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
                connectorsHTML += '<thead><tr style="background: #1a237e; color: white;">';
                connectorsHTML += '<th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Connector Name</th>';
                connectorsHTML += '<th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Type</th>';
                connectorsHTML += '<th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Device Slot</th>';
                connectorsHTML += '<th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Risk Level</th>';
                connectorsHTML += '<th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Voltage</th>';
                connectorsHTML += '</tr></thead><tbody>';
                
                allConnectors.forEach((conn, idx) => {
                    const rowColor = idx % 2 === 0 ? '#ffffff' : '#f5f5f5';
                    const deviceSlot = getDeviceSlotName(conn.name);
                    connectorsHTML += `<tr style="background: ${rowColor};">`;
                    connectorsHTML += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${conn.name || 'Unknown'}</strong></td>`;
                    connectorsHTML += `<td style="padding: 10px; border: 1px solid #ddd;">${conn.connector_type || 'Unknown'}</td>`;
                    connectorsHTML += `<td style="padding: 10px; border: 1px solid #ddd;">${deviceSlot}</td>`;
                    connectorsHTML += `<td style="padding: 10px; border: 1px solid #ddd;">${conn.risk_level || 'Medium'}</td>`;
                    connectorsHTML += `<td style="padding: 10px; border: 1px solid #ddd;">${conn.voltage || 'Unknown'}</td>`;
                    connectorsHTML += '</tr>';
                });
                
                connectorsHTML += '</tbody></table>';
                connectorsHTML += `<p style="margin-top: 15px; color: #666; font-weight: bold;"><strong>Total Connectors Detected:</strong> ${allConnectors.length}</p>`;
                connectorsDiv.innerHTML = connectorsHTML;
            } else if (connectorsDiv) {
                connectorsDiv.innerHTML = '<p style="color: #666;">No connectors detected</p>';
            }
            
            // Display annotated motherboard image
            const annotatedImageContainer = document.getElementById('annotatedImageContainer');
            if (annotatedImageContainer && data.annotated_image) {
                const imageUrl = `${BACKEND_URL}/api/download-annotated/${data.annotated_image}`;
                annotatedImageContainer.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        <img src="${imageUrl}" 
                             alt="Annotated Motherboard Image" 
                             style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #667eea;"
                             onerror="this.parentElement.innerHTML='<p style=\\'color: #f44336;\\'>Image not available</p>'">
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">
                            <strong>Component Mapping:</strong> All detected connectors and slots are marked with bounding boxes and labels on the motherboard image.
                        </p>
                    </div>
                `;
            } else if (annotatedImageContainer) {
                annotatedImageContainer.innerHTML = '<p style="color: #666;">Annotated image will be available after analysis...</p>';
            }
            
            // Display all connectors with their SOPs - Sequential Installation Guide
            const allConnectorsWithSOPsDiv = document.getElementById('allConnectorsWithSOPs');
            const allConnectorsWithSOPs = data.all_connectors_with_sops || [];
            if (allConnectorsWithSOPsDiv && allConnectorsWithSOPs.length > 0) {
                let sopsHTML = '<div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #4caf50;">';
                sopsHTML += '<h2 style="color: #1a237e; margin-bottom: 10px;">üìã Complete Installation Sequence</h2>';
                sopsHTML += `<p style="font-size: 16px; color: #2e7d32;"><strong>Total Connectors to Install: ${allConnectorsWithSOPs.length}</strong></p>`;
                sopsHTML += '<p style="color: #666;">Follow these steps in order to install all components on the motherboard:</p>';
                sopsHTML += '</div>';
                
                allConnectorsWithSOPs.forEach((item, idx) => {
                    const component = item.component || {};
                    const sopSteps = item.sop_steps || [];
                    const explanations = item.explanations || [];
                    const qaResult = item.qa_result || {};
                    const locationDesc = component.location_description || component.typical_location || '';
                    
                    sopsHTML += `<div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">`;
                    sopsHTML += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
                    sopsHTML += `<h3 style="margin: 0; font-size: 1.5em;">Step ${idx + 1}: Install ${component.name || 'Unknown'} on MB</h3>`;
                    if (locationDesc) {
                        sopsHTML += `<p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">üìç Location: ${locationDesc}</p>`;
                    }
                    sopsHTML += `</div>`;
                    
                    // Component details
                    sopsHTML += `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
                    sopsHTML += `<p><strong>Type:</strong> ${component.connector_type || 'Unknown'}</p>`;
                    sopsHTML += `<p><strong>Risk Level:</strong> ${component.risk_level || 'Medium'}</p>`;
                    sopsHTML += `<p><strong>Voltage:</strong> ${component.voltage || 'Unknown'}</p>`;
                    sopsHTML += `<p><strong>Pin Count:</strong> ${component.pin_count || 'Unknown'}</p>`;
                    sopsHTML += `</div>`;
                    
                    // SOP Steps
                    sopsHTML += `<h4 style="color: #283593; margin-top: 20px; margin-bottom: 10px;">üìù Installation Steps:</h4>`;
                    sopsHTML += `<ol style="margin-left: 20px;">`;
                    sopSteps.forEach((step, stepIdx) => {
                        sopsHTML += `<li style="margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 5px;">${step}</li>`;
                    });
                    sopsHTML += `</ol>`;
                    
                    // Explanations
                    if (explanations.length > 0) {
                        sopsHTML += `<h4 style="color: #283593; margin-top: 20px; margin-bottom: 10px;">üí° Detailed Explanations:</h4>`;
                        explanations.forEach((exp, expIdx) => {
                            sopsHTML += `<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #2196F3;">`;
                            sopsHTML += `<p><strong>Step ${exp.step_number}:</strong> ${exp.step_text}</p>`;
                            sopsHTML += `<p><strong>Explanation:</strong> ${exp.explanation || 'N/A'}</p>`;
                            sopsHTML += `<p><strong>Why Important:</strong> ${exp.why_important || 'N/A'}</p>`;
                            if (exp.common_mistakes) {
                                sopsHTML += `<p><strong>Common Mistakes:</strong> ${exp.common_mistakes}</p>`;
                            }
                            sopsHTML += `</div>`;
                        });
                    }
                    
                    // QA Result
                    if (qaResult.status) {
                        sopsHTML += `<h4 style="color: #283593; margin-top: 20px; margin-bottom: 10px;">‚úÖ QA Validation:</h4>`;
                        sopsHTML += `<div style="background: ${qaResult.status === 'Approved' ? '#e8f5e9' : '#fff3e0'}; padding: 15px; border-radius: 8px;">`;
                        sopsHTML += `<p><strong>Status:</strong> ${qaResult.status || 'Unknown'}</p>`;
                        sopsHTML += `<p><strong>Safety Score:</strong> ${qaResult.safety_score || 0}/100</p>`;
                        if (qaResult.warnings && qaResult.warnings.length > 0) {
                            sopsHTML += `<p><strong>Warnings:</strong></p><ul style="margin-left: 20px;">`;
                            qaResult.warnings.forEach(w => sopsHTML += `<li>${w}</li>`);
                            sopsHTML += `</ul>`;
                        }
                        sopsHTML += `</div>`;
                    }
                    
                    sopsHTML += `</div>`;
                });
                allConnectorsWithSOPsDiv.innerHTML = sopsHTML;
            } else if (allConnectorsWithSOPsDiv) {
                allConnectorsWithSOPsDiv.innerHTML = '<p style="color: #666;">No connector SOPs available</p>';
            }
            
            // Display component info
            const component = data.target_component || {};
            const componentInfo = document.getElementById('componentInfo');
            componentInfo.innerHTML = `
                <div class="info-item">
                    <strong>Component Name</strong>
                    ${component.name || 'Unknown'}
                </div>
                <div class="info-item">
                    <strong>Connector Type</strong>
                    ${component.connector_type || 'Unknown'}
                </div>
                <div class="info-item">
                    <strong>Risk Level</strong>
                    ${component.risk_level || 'Medium'}
                </div>
                <div class="info-item">
                    <strong>Voltage</strong>
                    ${component.voltage || 'Unknown'}
                </div>
            `;

            // Display SOP steps
            const sopSteps = document.getElementById('sopSteps');
            sopSteps.innerHTML = '';
            (data.sop_steps || []).forEach(step => {
                const li = document.createElement('li');
                li.textContent = step;
                sopSteps.appendChild(li);
            });

            // Display explanations
            const explanationsDiv = document.getElementById('explanations');
            explanationsDiv.innerHTML = '';
            (data.explanations || []).forEach(exp => {
                const div = document.createElement('div');
                div.className = 'explanation-item';
                div.innerHTML = `
                    <h3>Step ${exp.step_number}: ${exp.step_text}</h3>
                    <p><strong>Explanation:</strong> ${exp.explanation}</p>
                    <p><strong>Why Important:</strong> ${exp.why_important}</p>
                    ${exp.common_mistakes ? `<p><strong>Common Mistakes:</strong> ${exp.common_mistakes}</p>` : ''}
                `;
                explanationsDiv.appendChild(div);
            });

            // Display QA result
            const qaResult = data.qa_result || {};
            const qaDiv = document.getElementById('qaResult');
            const statusClass = qaResult.status === 'Approved' ? 'approved' : 
                               qaResult.status === 'Approved with Warnings' ? 'warning' : 'revision';
            qaDiv.innerHTML = `
                <div class="qa-status ${statusClass}">
                    <strong>Status:</strong> ${qaResult.status || 'Unknown'}<br>
                    <strong>Safety Score:</strong> ${qaResult.safety_score || 0}/100
                </div>
                ${qaResult.warnings && qaResult.warnings.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong>Warnings:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${qaResult.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${qaResult.recommendations && qaResult.recommendations.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong>Recommendations:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${qaResult.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;

            // Show results
            document.getElementById('results').classList.add('active');
        }

        function getDeviceSlotName(connectorName) {
            const mapping = {
                "Keyboard Connector": "Keyboard Slot",
                "RAM Slot": "Memory Module Slot (SO-DIMM)",
                "Fan Connector": "CPU/System Fan Slot",
                "Battery Connector": "Battery Power Slot",
                "Display Connector": "LCD/Display Panel Slot",
                "USB Connector": "USB Port Slot",
                "Power Connector": "DC Power Input Slot"
            };
            return mapping[connectorName] || `${connectorName} Slot`;
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!currentPdfPath) {
                showError('PDF path not available');
                return;
            }

            const filename = currentPdfPath.split('/').pop();
            window.open(`${BACKEND_URL}/api/download-pdf/${filename}`, '_blank');
        });

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // AOI Form Handler
        document.getElementById('aoiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const imageFile = document.getElementById('aoiImageUpload').files[0];
            const partNumber = document.getElementById('partNumber').value || 'N/A';
            const lotNumber = document.getElementById('lotNumber').value || 'N/A';

            if (!imageFile) {
                alert('Please upload an AOI inspection image');
                return;
            }

            formData.append('image', imageFile);
            formData.append('part_number', partNumber);
            formData.append('lot_number', lotNumber);

            document.getElementById('aoiLoading').classList.add('active');
            document.getElementById('aoiResults').classList.remove('active');
            document.getElementById('analyzeAoiBtn').disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/api/aoi/analyze`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to analyze AOI image');
                }

                displayAOIResults(data);
                document.getElementById('aoiResults').classList.add('active');

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('aoiLoading').classList.remove('active');
                document.getElementById('analyzeAoiBtn').disabled = false;
            }
        });

        function displayAOIResults(data) {
            // Detection Results
            const detectionDiv = document.getElementById('aoiDetectionResults');
            const detection = data.detection_result || {};
            detectionDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <p><strong>Status:</strong> <span style="color: ${detection.status === 'PASS' ? '#4caf50' : '#f44336'}; font-weight: bold;">${detection.status || 'UNKNOWN'}</span></p>
                    <p><strong>Total Defects:</strong> ${detection.total_defects || 0}</p>
                    <p><strong>Critical Defects:</strong> ${detection.critical_defects || 0}</p>
                    <p><strong>Confidence:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
                    <p><strong>Detection Method:</strong> ${detection.detection_method || 'Unknown'}</p>
                    ${data.false_positive_reduction ? `
                        <p><strong>False Positive Reduction:</strong> ${data.false_positive_reduction.reduction_percentage}% (${data.false_positive_reduction.false_positives_removed} removed)</p>
                    ` : ''}
                </div>
            `;

            // Defects List
            const defectsDiv = document.getElementById('aoiDefects');
            const defects = data.classified_defects || [];
            if (defects.length > 0) {
                let defectsHTML = '';
                defects.forEach(defect => {
                    const severity = defect.severity?.toLowerCase() || 'medium';
                    defectsHTML += `
                        <div class="defect-item ${severity}">
                            <h4>${defect.type || 'Unknown Defect'}</h4>
                            <p><strong>Severity:</strong> ${defect.severity || 'Medium'}</p>
                            <p><strong>Confidence:</strong> ${(defect.confidence * 100).toFixed(1)}%</p>
                            <p><strong>Description:</strong> ${defect.description || 'N/A'}</p>
                            <p><strong>Action Required:</strong> ${defect.action_required || 'N/A'}</p>
                            <p><strong>False Positive Risk:</strong> ${defect.false_positive_risk || 'Medium'}</p>
                            ${defect.root_cause && defect.root_cause.length > 0 ? `
                                <p><strong>Root Causes:</strong></p>
                                <ul style="margin-left: 20px;">
                                    ${defect.root_cause.map(rc => `<li>${rc}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                });
                defectsDiv.innerHTML = defectsHTML;
            } else {
                defectsDiv.innerHTML = '<p style="color: #4caf50; font-weight: bold;">‚úÖ No defects detected!</p>';
            }

            // QC Report
            const qcReportDiv = document.getElementById('aoiQCReport');
            const qcReport = data.qc_report || {};
            qcReportDiv.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h4>QC Inspection Report</h4>
                    <p><strong>Part Number:</strong> ${qcReport.part_number || 'N/A'}</p>
                    <p><strong>Lot Number:</strong> ${qcReport.lot_number || 'N/A'}</p>
                    <p><strong>Inspection Date:</strong> ${qcReport.inspection_date || 'N/A'}</p>
                    <p><strong>Status:</strong> <span style="color: ${qcReport.status === 'PASS' ? '#4caf50' : '#f44336'}; font-weight: bold;">${qcReport.status || 'UNKNOWN'}</span></p>
                    <p><strong>Quality Score:</strong> ${qcReport.quality_score || 0}/100</p>
                    
                    <h5 style="margin-top: 15px;">Summary:</h5>
                    <ul style="margin-left: 20px;">
                        <li>Total Defects: ${qcReport.summary?.total_defects || 0}</li>
                        <li>Critical: ${qcReport.summary?.critical_defects || 0}</li>
                        <li>High: ${qcReport.summary?.high_defects || 0}</li>
                        <li>Medium: ${qcReport.summary?.medium_defects || 0}</li>
                    </ul>

                    <h5 style="margin-top: 15px;">Recommendations:</h5>
                    <ul style="margin-left: 20px;">
                        ${(qcReport.recommendations || []).map(r => `<li>${r}</li>`).join('')}
                    </ul>

                    <h5 style="margin-top: 15px;">Next Actions:</h5>
                    <ul style="margin-left: 20px;">
                        ${(qcReport.next_actions || []).map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Equipment Monitoring Handlers
        document.getElementById('loadDashboardBtn').addEventListener('click', async () => {
            document.getElementById('equipmentLoading').classList.add('active');
            document.getElementById('equipmentDashboard').classList.remove('active');

            try {
                const response = await fetch(`${BACKEND_URL}/api/equipment/dashboard`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load dashboard');
                }

                displayEquipmentDashboard(data);
                document.getElementById('equipmentDashboard').classList.add('active');

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('equipmentLoading').classList.remove('active');
            }
        });

        document.getElementById('refreshEquipmentBtn').addEventListener('click', async () => {
            document.getElementById('loadDashboardBtn').click();
        });

        function displayEquipmentDashboard(data) {
            // Summary
            const summaryDiv = document.getElementById('equipmentSummary');
            const summary = data.summary || {};
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #1a237e; margin: 0;">${summary.total_equipment || 0}</h3>
                        <p style="color: #666; margin: 5px 0 0 0;">Total Equipment</p>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #f44336; margin: 0;">${summary.critical || 0}</h3>
                        <p style="color: #666; margin: 5px 0 0 0;">Critical</p>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #ff9800; margin: 0;">${summary.warning || 0}</h3>
                        <p style="color: #666; margin: 5px 0 0 0;">Warning</p>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #4caf50; margin: 0;">${summary.normal || 0}</h3>
                        <p style="color: #666; margin: 5px 0 0 0;">Normal</p>
                    </div>
                </div>
            `;

            // Equipment List
            const equipmentListDiv = document.getElementById('equipmentList');
            const equipment = data.equipment || [];
            if (equipment.length > 0) {
                let equipmentHTML = '';
                equipment.forEach(eq => {
                    const alertLevel = eq.alert_level || 'NONE';
                    let cardClass = 'normal';
                    if (alertLevel === 'IMMEDIATE_ACTION') cardClass = 'critical';
                    else if (alertLevel === 'REVIEW_REQUIRED') cardClass = 'warning';

                    equipmentHTML += `
                        <div class="equipment-card ${cardClass}">
                            <h4 style="margin: 0 0 10px 0; color: #1a237e;">${eq.equipment_id}</h4>
                            <p style="margin: 5px 0; color: #666;"><strong>Type:</strong> ${eq.equipment_type || 'Unknown'}</p>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${eq.status === 'RUNNING' ? '#4caf50' : '#f44336'}">${eq.status || 'UNKNOWN'}</span></p>
                            <p style="margin: 5px 0;"><strong>Anomaly Status:</strong> <span style="color: ${eq.anomaly_status === 'NORMAL' ? '#4caf50' : '#f44336'}">${eq.anomaly_status || 'UNKNOWN'}</span></p>
                            <p style="margin: 5px 0;"><strong>Alert Level:</strong> <span style="color: ${alertLevel === 'NONE' ? '#4caf50' : '#f44336'}">${alertLevel}</span></p>
                            <p style="margin: 5px 0;"><strong>Anomalies:</strong> ${eq.anomaly_count || 0}</p>
                            ${eq.critical_anomalies > 0 ? `<p style="margin: 5px 0; color: #f44336;"><strong>Critical Anomalies:</strong> ${eq.critical_anomalies}</p>` : ''}
                            ${eq.predictions && eq.predictions.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <strong>Predictions:</strong>
                                    <ul style="margin: 5px 0 0 20px; font-size: 12px;">
                                        ${eq.predictions.map(p => `<li>${p.message || p.type}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                equipmentListDiv.innerHTML = equipmentHTML;
            } else {
                equipmentListDiv.innerHTML = '<p style="color: #666;">No equipment data available</p>';
            }
        }

        // Load dashboard on equipment tab activation
        document.getElementById('equipment-tab').addEventListener('click', () => {
            setTimeout(() => {
                if (document.getElementById('equipment-tab').classList.contains('active')) {
                    document.getElementById('loadDashboardBtn').click();
                }
            }, 100);
        });
    </script>
</body>
</html>

